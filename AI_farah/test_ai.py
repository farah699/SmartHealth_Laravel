import sys
import os
from exercise_recommendation_ai import ExerciseRecommendationAI

def test_ai_model():
    """Test complet du mod√®le IA"""
    
    print("=" * 60)
    print("SYST√àME DE TEST DU MOD√àLE IA - RECOMMANDATIONS D'EXERCICES")
    print("=" * 60)
    
    try:
        # 1. Test de chargement des datasets
        print("\n1. TEST DE CHARGEMENT DES DATASETS")
        print("-" * 30)
        
        ai = ExerciseRecommendationAI()
        
        if not ai.load_datasets_from_files():
            print("‚ùå √âchec du chargement des datasets")
            return False
        
        # 2. Test d'entra√Ænement du mod√®le
        print("\n2. ENTRA√éNEMENT DU MOD√àLE")
        print("-" * 30)
        
        performance = ai.train_model_from_files()
        
        if not performance:
            print("‚ùå √âchec de l'entra√Ænement du mod√®le")
            return False
        
        print("‚úÖ Mod√®le entra√Æn√© avec succ√®s!")
        print(f"   - MSE: {performance['mse']:.2f}")
        print(f"   - R¬≤ Score: {performance['r2']:.3f}")
        
        # √âvaluation de la performance
        if performance['r2'] > 0.7:
            print("üéâ Excellente performance du mod√®le!")
        elif performance['r2'] > 0.5:
            print("‚úÖ Bonne performance du mod√®le")
        else:
            print("‚ö†Ô∏è Performance moyenne du mod√®le")
        
        # 3. Test de g√©n√©ration de recommandations
        print("\n3. TEST DE G√âN√âRATION DE RECOMMANDATIONS")
        print("-" * 45)
        
        # Profils de test vari√©s
        test_profiles = [
            {
                'name': 'D√©butant jeune',
                'profile': {
                    'age': 25,
                    'imc': 22.0,
                    'fitness_level': 'beginner',
                    'activity_frequency': 2,
                    'experience_months': 1,
                    'has_medical_constraints': False
                }
            },
            {
                'name': 'Interm√©diaire actif',
                'profile': {
                    'age': 35,
                    'imc': 24.5,
                    'fitness_level': 'intermediate',
                    'activity_frequency': 4,
                    'experience_months': 12,
                    'has_medical_constraints': False
                }
            },
            {
                'name': 'Senior avec contraintes',
                'profile': {
                    'age': 55,
                    'imc': 27.0,
                    'fitness_level': 'beginner',
                    'activity_frequency': 2,
                    'experience_months': 3,
                    'has_medical_constraints': True
                }
            },
            {
                'name': 'Sportif avanc√©',
                'profile': {
                    'age': 28,
                    'imc': 21.5,
                    'fitness_level': 'advanced',
                    'activity_frequency': 6,
                    'experience_months': 36,
                    'has_medical_constraints': False
                }
            }
        ]
        
        all_tests_passed = True
        
        for i, test_case in enumerate(test_profiles, 1):
            print(f"\nüß™ Test {i}: {test_case['name']}")
            profile = test_case['profile']
            print(f"   üë§ √Çge: {profile['age']}, IMC: {profile['imc']}, Niveau: {profile['fitness_level']}")
            
            try:
                recommendations = ai.get_recommendations(profile, limit=5)
                
                if recommendations and len(recommendations) > 0:
                    print(f"   ‚úÖ {len(recommendations)} recommandations g√©n√©r√©es")
                    
                    # Afficher le top 3
                    print("   üèÜ Top 3 des recommandations:")
                    for j, rec in enumerate(recommendations[:3], 1):
                        print(f"      {j}. {rec['exercise_name']} (Score: {rec['predicted_score']:.1f}%)")
                    
                    # V√©rifications de coh√©rence
                    scores = [r['predicted_score'] for r in recommendations]
                    if all(scores[i] >= scores[i+1] for i in range(len(scores)-1)):
                        print("   ‚úÖ Recommandations bien tri√©es par score")
                    else:
                        print("   ‚ö†Ô∏è Probl√®me de tri des recommandations")
                        all_tests_passed = False
                    
                    # V√©rifier que les scores sont dans la plage attendue
                    if all(0 <= score <= 100 for score in scores):
                        print("   ‚úÖ Scores dans la plage valide (0-100)")
                    else:
                        print("   ‚ùå Scores hors de la plage valide")
                        all_tests_passed = False
                    
                else:
                    print("   ‚ùå Aucune recommandation g√©n√©r√©e")
                    all_tests_passed = False
                    
            except Exception as e:
                print(f"   ‚ùå Erreur lors de la g√©n√©ration: {e}")
                all_tests_passed = False
        
        # 4. Test de sauvegarde/chargement du mod√®le
        print("\n4. TEST DE PERSISTANCE DU MOD√àLE")
        print("-" * 33)
        
        # Test de sauvegarde
        if ai.save_model():
            print("‚úÖ Sauvegarde du mod√®le r√©ussie")
        else:
            print("‚ùå √âchec de la sauvegarde")
            all_tests_passed = False
        
        # Test de chargement
        new_ai = ExerciseRecommendationAI()
        if new_ai.load_model():
            print("‚úÖ Chargement du mod√®le r√©ussi")
            
            # Test rapide du mod√®le charg√©
            test_profile = {
                'age': 30,
                'imc': 25.0,
                'fitness_level': 'intermediate',
                'activity_frequency': 3,
                'experience_months': 6,
                'has_medical_constraints': False
            }
            
            loaded_recommendations = new_ai.get_recommendations(test_profile, limit=3)
            if loaded_recommendations:
                print("‚úÖ Mod√®le charg√© fonctionne correctement")
            else:
                print("‚ùå Probl√®me avec le mod√®le charg√©")
                all_tests_passed = False
        else:
            print("‚ùå √âchec du chargement")
            all_tests_passed = False
        
        # 5. R√©sum√© final
        print("\n" + "=" * 60)
        print("R√âSUM√â DES TESTS")
        print("=" * 60)
        
        if all_tests_passed:
            print("üéâ TOUS LES TESTS SONT PASS√âS AVEC SUCC√àS!")
            print("‚úÖ Le mod√®le IA est pr√™t pour la production")
            print(f"üìä Performance globale: R¬≤ = {performance['r2']:.3f}")
            
            print("\nüí° PROCHAINES √âTAPES:")
            print("1. Testez l'int√©gration Laravel:")
            print("   http://127.0.0.1:8000/exercise/recommendations")
            print("2. Cliquez sur 'IA en cours...' pour voir les recommandations")
            print("3. V√©rifiez les logs Laravel si n√©cessaire")
            
        else:
            print("‚ö†Ô∏è CERTAINS TESTS ONT √âCHOU√â")
            print("üîß V√©rifiez les erreurs ci-dessus et corrigez avant la production")
        
        return all_tests_passed
        
    except Exception as e:
        print(f"\nüí• ERREUR CRITIQUE LORS DES TESTS: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_specific_user_profile():
    """Test avec un profil utilisateur sp√©cifique (comme l'utilisateur connect√©)"""
    
    print("\n" + "üéØ" * 20)
    print("TEST AVEC PROFIL UTILISATEUR SP√âCIFIQUE")
    print("üéØ" * 20)
    
    # Profil bas√© sur l'utilisateur connect√© de votre capture d'√©cran
    user_profile = {
        'age': 28,
        'imc': 26.1,
        'fitness_level': 'beginner',  # D√©butant comme affich√©
        'activity_frequency': 1,      # 1 activit√© comme affich√©
        'experience_months': 2,
        'has_medical_constraints': False
    }
    
    print(f"üë§ PROFIL UTILISATEUR:")
    print(f"   üéÇ √Çge: {user_profile['age']} ans")
    print(f"   ‚öñÔ∏è IMC: {user_profile['imc']}")
    print(f"   üèÉ Niveau: {user_profile['fitness_level']}")
    print(f"   üìÖ Fr√©quence: {user_profile['activity_frequency']} activit√©(s)/semaine")
    
    ai = ExerciseRecommendationAI()
    
    # Charger le mod√®le pr√©-entra√Æn√©
    if not ai.load_model():
        print("‚ùå Impossible de charger le mod√®le. Assurez-vous qu'il est entra√Æn√©.")
        return False
    
    print("\nü§ñ G√©n√©ration des recommandations personnalis√©es...")
    recommendations = ai.get_recommendations(user_profile, limit=10)
    
    if recommendations:
        print(f"\nüèÜ TOP {len(recommendations)} RECOMMANDATIONS POUR VOUS:")
        print("=" * 50)
        
        for i, rec in enumerate(recommendations, 1):
            # √âmojis selon le type
            emoji_map = {
                'cardio': '‚ù§Ô∏è',
                'strength': 'üí™',
                'flexibility': 'üßò',
                'balance': '‚öñÔ∏è'
            }
            emoji = emoji_map.get(rec['exercise_type'], 'üèÉ')
            
            # Badge de qualit√© selon le score
            score = rec['predicted_score']
            if score >= 85:
                badge = "ü•á EXCELLENT"
            elif score >= 75:
                badge = "ü•à TR√àS BON"
            elif score >= 65:
                badge = "ü•â BON"
            else:
                badge = "‚úÖ CORRECT"
            
            print(f"\n{i:2d}. {emoji} {rec['exercise_name']}")
            print(f"     {badge} - Score IA: {score:.1f}%")
            print(f"     ‚è±Ô∏è Dur√©e recommand√©e: {rec['recommended_duration']} minutes")
            print(f"     üìä Difficult√©: {rec['difficulty_level']}/10")
            print(f"     üî• Calories/minute: {rec['calories_per_minute']}")
            print(f"     üè∑Ô∏è Cat√©gorie: {rec['exercise_category']}")
            print(f"     üí° Pourquoi: {rec['recommendation_reason']}")
        
        print(f"\nüìà ANALYSE DE VOS RECOMMANDATIONS:")
        print("-" * 35)
        
        # Analyser les types d'exercices recommand√©s
        types_count = {}
        for rec in recommendations:
            ex_type = rec['exercise_type']
            types_count[ex_type] = types_count.get(ex_type, 0) + 1
        
        for ex_type, count in types_count.items():
            emoji = emoji_map.get(ex_type, 'üèÉ')
            percentage = (count / len(recommendations)) * 100
            print(f"{emoji} {ex_type.capitalize()}: {count} exercices ({percentage:.1f}%)")
        
        avg_score = sum(r['predicted_score'] for r in recommendations) / len(recommendations)
        avg_duration = sum(r['recommended_duration'] for r in recommendations) / len(recommendations)
        
        print(f"\nüìä Score moyen de compatibilit√©: {avg_score:.1f}%")
        print(f"‚è±Ô∏è Dur√©e moyenne recommand√©e: {avg_duration:.1f} minutes")
        
        return True
    else:
        print("‚ùå Aucune recommandation g√©n√©r√©e pour ce profil")
        return False

if __name__ == "__main__":
    print("üöÄ LANCEMENT DES TESTS DU MOD√àLE IA")
    
    # Test g√©n√©ral du mod√®le
    success = test_ai_model()
    
    if success:
        # Test avec profil utilisateur sp√©cifique
        test_specific_user_profile()
    
    print(f"\n{'='*60}")
    print("FIN DES TESTS")
    print(f"{'='*60}")